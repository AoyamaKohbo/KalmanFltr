<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="ja">

  <head>
    <script type="text/x-mathjax-config">

       MathJax.Hub.Config({TeX:{alignNumbers:{autoNumber:"AMS"}}});

    </script>

    <script type="text/javascript" async 

        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">

    </script>

  </head>

  <body>
    <p>カルマンフィルタ(Kalman Filter)</p>

    \begin{align}
      \mathbf{x}(n+1)&=~\mathbf{A}\mathbf{x}(n)+\mathbf{B}\mathbf{u}(n)+\mathbf{w}(n)\label{eq:RtnEqn}\\
      \mathbf{y}(n)&=~\mathbf{C}\mathbf{x}(n)+\mathbf{v}(n)
    \end{align}

    \begin{align}
      \hat{\mathbf{x}}(n)={\mathbf{X}}(n)+\mathbf{K}(n)\mathbf{e}(n)\label{eq:KalmanFilt}
    \end{align}
    
    \begin{align}
      \mathbf{e}(n)&=~\mathbf{y}(n)-\mathbf{C}\mathbf{X}(n)\\
      {\mathbf{X}}(n+1)&=~\mathbf{A}\hat{\mathbf{x}}(n)+\mathbf{B}\mathbf{u}(n)\\
      \mathbf{K}(n)&=~\mathbf{X}\mathbf{C}^T\mathbf{V}^{-1}\\
      \mathbf{X}&=~(\mathbf{I}-\mathbf{K}(n)\mathbf{C})(\mathbf{A}\mathbf{X}\mathbf{A}^T+\mathbf{W})\\
      \mathbf{V}&=~E[\mathbf{v}(n)\mathbf{v}(n)^T]\\
      \mathbf{W}&=~E[\mathbf{w}(n)\mathbf{w}(n)^T]
    \end{align} 

    \begin{align}
      \tilde{\mathbf{x}}(n)=\mathbf{x}(n)-\hat{\mathbf{x}}(n)
    \end{align}

    \begin{align}
      J=E[\tilde{\mathbf{x}}^T(n)\tilde{\mathbf{x}}(n)]
    \end{align}

    \begin{align}
      \mathbf{z}(n+1)&=~\mathbf{x}(n+1)-\mathbf{X}(n+1)\\
      &=~\mathbf{A}\tilde{\mathbf{x}}(n)+\mathbf{w}(n)
    \end{align}

    \begin{align}
      \tilde{\mathbf{x}}(n)&=~\mathbf{x}(n)-\hat{\mathbf{x}}(n)\nonumber\\
      &=~\mathbf{x}(n)-\mathbf{X}(n)-\mathbf{K}(n)\{\mathbf{C}\hat{\mathbf{x}}(n)+\hat{\mathbf{v}}(n)-\hat{\mathbf{C}}\mathbf{X}(n)\}\nonumber\\
      &=~(\mathbf{I}-\mathbf{K}(n)\mathbf{C})\mathbf{z}(n)-\mathbf{K}(n)\mathbf{v}(n)\label{eq:ErrorOfEst}
    \end{align}

    \(E[\tilde{\mathbf{z}}(n)\tilde{\mathbf{v}}^T(n)]=\mathbf{O}\)
      \begin{align}
      J&=~E[{\mathbf{z}(n)^T(\mathbf{I}-\mathbf{K}(n)\mathbf{C})^T(\mathbf{I}-\mathbf{K}(n)\mathbf{C})\mathbf{z}(n)}]+E[\mathbf{v}(n)^T\mathbf{K}(n)^T\mathbf{K}(n)\mathbf{v}(n)]\nonumber\\
      &=~E[\mathbf{z}(n)^T\mathbf{z}(n)]-E[{\mathbf{z}(n)^T\mathbf{K}(n)\mathbf{C}\mathbf{z}(n)}]-E[{\mathbf{z}(n)^T\mathbf{C}^T\mathbf{K}(n)^T\mathbf{z}(n)}]+E[{\mathbf{z}(n)^T\mathbf{C}^T\mathbf{K}(n)^T\mathbf{K}(n)\mathbf{C}\mathbf{z}(n)}]
    +E[\mathbf{v}(n)^T\mathbf{K}(n)^T\mathbf{K}(n)\mathbf{v}(n)]
    \end{align}

    \begin{align}
      \frac{\partial J}{\partial\mathbf{K}(n)}=-2E[{\mathbf{z}(n)^T\mathbf{z}(n)]\mathbf{C}}-2\mathbf{K}(n)\mathbf{C}E[{\mathbf{z}(n)^T\mathbf{z}(n)}]\mathbf{C}+2\mathbf{K}(n)E[\mathbf{v}(n)^T\mathbf{v}(n)]=\mathbf{O}
    \end{align}

    \begin{align}
      \mathbf{Z}=E[\mathbf{z}(n)\mathbf{z}^T(n)]
    \end{align}

    \begin{align}
      \frac{\partial J}{\partial\mathbf{K}(n)}=-2\mathbf{Z}\mathbf{C}^T-2\mathbf{K}(n)\mathbf{C}\mathbf{Z}\mathbf{C}^T+2\mathbf{K}(n)\mathbf{V}=\mathbf{O}
    \end{align}

    \begin{align}
      \mathbf{K}(n)\mathbf{C}\mathbf{Z}\mathbf{C}^T+\mathbf{K}(n)\mathbf{V}=\mathbf{Z}\mathbf{C}^T\label{eq:KalmanGain1}
    \end{align}

  \(E[\tilde{\mathbf{x}}(n)\tilde{\mathbf{w}}^T(n)]=\mathbf{O}\)(\eqref{eq:ErrorOfEst})

    \begin{align}
      E[\mathbf{z}(n+1)\mathbf{z}^T(n+1)]&=~E[\{\mathbf{A}\tilde{\mathbf{x}}(n)+\mathbf{w}(n)\}\{\mathbf{A}\tilde{\mathbf{x}}(n)+\mathbf{w}(n)^T]\nonumber\\
      &=~\mathbf{A}E[\tilde{\mathbf{x}}(n)\tilde{\mathbf{x}}(n)^T]\mathbf{A}^T+E[\mathbf{w}(n)\mathbf{w}(n)^T\}]\label{eq:VarMatOfZ}
    \end{align}

    \begin{align}
      \mathbf{X}=E[\tilde{\mathbf{x}}(n)\tilde{\mathbf{x}}^T(n)]\label{eq:CovarMatOfError}
    \end{align}

    \begin{align}
      \mathbf{Z}=\mathbf{A}\mathbf{X}\mathbf{A}^T+\mathbf{W}\label{eq:VarMatOfZ2}
    \end{align}

    (\eqref{eq:ErrorOfEst})(\eqref{eq:CovarMatOfError})

    \begin{align}
      \mathbf{X}=E[\{(\mathbf{I}-\mathbf{K}(n)\mathbf{C})\mathbf{z}(n)-\mathbf{K}(n)\mathbf{v}(n)\}\{(\mathbf{I}-\mathbf{K}(n)\mathbf{C})\mathbf{z}(n)-\mathbf{K}(n)\mathbf{v}(n)\}^T]\label{eq:CovarMatOfError2}
    \end{align}

    \(E[\mathbf{z}(n)\mathbf{v}^T(n)]=\mathbf{O}\)(\eqref{eq:CovarMatOfError2})

    \begin{align}
      \mathbf{X}=(\mathbf{I}-\mathbf{K}(n)\mathbf{C})\mathbf{Z}(\mathbf{I}-\mathbf{K}(n)\mathbf{C})^T+\mathbf{K}(n)\mathbf{V}\mathbf{K}(n)^T\label{eq:MatP1}
    \end{align}

    (\eqref{eq:KalmanGain1})

    \begin{align}
      \mathbf{K}(n)\mathbf{V}\mathbf{K}(n)^T=(\mathbf{I}-\mathbf{K}(n)\mathbf{C}^T)\mathbf{Z}\mathbf{C}^T\mathbf{K}(n)^T
    \end{align}

   \begin{align}
      \mathbf{X}=(\mathbf{I}-\mathbf{K}(n)\mathbf{C})\mathbf{Z}\label{eq:MatP2}
    \end{align}

    \begin{align}
      \mathbf{X}=(\mathbf{I}-\mathbf{K}(n)\mathbf{C})(\mathbf{A}\mathbf{X}\mathbf{A}^T+\mathbf{W}^T)
    \end{align}

    \begin{align}
      \mathbf{K}(n)\mathbf{V}=\mathbf{X}\mathbf{C}^T
    \end{align}

    \begin{align}
      \mathbf{K}(n)=\mathbf{X}\mathbf{C}^T\mathbf{V}^{-1}
    \end{align}
</body>

</html>
