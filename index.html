<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="ja">

  <head>
    <script type="text/x-mathjax-config">

       MathJax.Hub.Config({TeX:{equationNumbers:{autoNumber:"AMS"}}});

    </script>

    <script type="text/javascript" async 

        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">

    </script>

  </head>

  <body>
    <h3>定常カルマンフィルター(Kalman Filter)</h3>

    <p>動的システムを次式の離散状態方程式で与えます。</p>
    \begin{align}
      \mathbf{x}(n+1)&=~\mathbf{A}\mathbf{x}(n)+\mathbf{B}\mathbf{u}(n)+\mathbf{w}(n)\label{eq:RtnEqn}\\
      \mathbf{y}(n)&=~\mathbf{C}\mathbf{x}(n)+\mathbf{v}(n)
    \end{align}
    <p>ここに、\(\mathbf{u}\)は入力ベクトル、\(\mathbf{x}\)は状態ベクトル、\(\mathbf{y}\)出力ベクトル、
      \(\mathbf{A}\)は遷移行列、\(\mathbf{B}\)は出力係数行列、\(\mathbf{C}\)は入力係数行列、\(\mathbf{v}\)出力ノイズベクトル、
      \(\mathbf{w}\)は入力ノイズベクトルです。\(\mathbf{v}\)、\(\mathbf{w}\)と\(\mathbf{u}\)、\(\mathbf{x}\)、\(\mathbf{y}\)
      は相関がありません。すなわち、相関係数は0とします。
    </p>
    
    <p>式\eqref{eq:RtnEqn}の状態観測器(オブザーバー)は次式となります。</p>
    \begin{align}
      \hat{\mathbf{x}}(n)&={\mathbf{p}}(n)+\mathbf{K}\mathbf{e}(n)\label{eq:KalmanFilt}\\
      \mathbf{e}(n)&=~\mathbf{y}(n)-\mathbf{C}\mathbf{p}(n)\\
      {\mathbf{p}}(n+1)&=~\mathbf{A}\hat{\mathbf{x}}(n)+\mathbf{B}\mathbf{u}(n)\\
    \end{align}
    <p>\(\hat{\mathbf{x}}\)は状態ベクトル\(\mathbf{x}\)を推定するベクトルです。
    \(\mathbf{K}\)はカルマンゲイン行列であり、次式で与えられます。</p>
    \begin{align}
      \mathbf{K}&=~\mathbf{P}\mathbf{C}^T\mathbf{V}^{-1}\\
      \mathbf{P}&=~(\mathbf{I}-\mathbf{K}\mathbf{C})(\mathbf{A}\mathbf{P}\mathbf{A}^T+\mathbf{W})\\
      \mathbf{V}&=~E[\mathbf{v}(n)^T\mathbf{v}(n)]\\
      \mathbf{W}&=~E[\mathbf{w}(n)^T\mathbf{w}(n)]
    \end{align}
    
    <p>\(E[*]\)は算術平均であり、\(E[*]\)の中が\(\mathbf{x}(n)\)の場合、次式で与えられます。</p>
    \begin{align*}
      E[\mathbf{x}(n)] = \frac{1}{n}\sum_{k = 0}^{n}\mathbf{x}(k)
    \end{align*}

    <h3>定常カルマンフィルターの導出</h3>
    <p>状態ベクトル\(\mathbf{x}\)の推定ベクトルの状態誤差ベクトル\(\tilde{x}\)を次式で与えます。</p>
    \begin{align}
      \tilde{\mathbf{x}}(n)=\mathbf{x}(n)-\hat{\mathbf{x}}(n)
    \end{align}

    <p>誤差ベクトルの評価式を次式で与えます。</p>
    \begin{align}
      J=E[\tilde{\mathbf{x}}^T(n)\tilde{\mathbf{x}}(n)]
    \end{align}

    <p>状態ベクトル\(\mathbf{x}\)の推定ベクトルの誤差ベクトルを次式で与えます。</p>
    \(\mathbf{z}(n) = \mathbf{x}(n) - \mathbf{p}(n)\)と定義すると、次式が得られます。
    \begin{align}
      \mathbf{z}(n+1)&=~\mathbf{x}(n+1)-\mathbf{p}(n+1)\\
      &=~\mathbf{A}\tilde{\mathbf{x}}(n)+\mathbf{w}(n) \label{eq:StateEqZ}
    \end{align}

    <p>状態誤差ベクトル\(\tilde{x}\)は次式となります。</p>
    \begin{align}
      \tilde{\mathbf{x}}(n)&=~\mathbf{x}(n)-\hat{\mathbf{x}}(n)\nonumber\\
      &=~\mathbf{x}(n)-\mathbf{p}(n)-\mathbf{K}\{\mathbf{C}\hat{\mathbf{x}}(n)+\hat{\mathbf{v}}(n)-\hat{\mathbf{C}}\mathbf{p}(n)\}\nonumber\\
      &=~(\mathbf{I}-\mathbf{K}\mathbf{C})\mathbf{z}(n)-\mathbf{K}\mathbf{v}(n)\label{eq:ErrorOfEst}
    \end{align}

    <p>誤差評価式\(J\)を次式で定義します。</p>
    \begin{align}
      J = E[\tilde{\mathbf{x}}(n)\tilde{\mathbf{x}}(n)^T] \label{eq:Evalation}
    \end{align}

    \(E[\tilde{\mathbf{z}}(n)\tilde{\mathbf{v}}^T(n)] = 0\)に注意すると、\(J\)は次式となります。
      \begin{align}
      J&=~E[{\mathbf{z}(n)^T(\mathbf{I}-\mathbf{K}\mathbf{C})^T(\mathbf{I}-\mathbf{K}\mathbf{C})\mathbf{z}(n)}]+E[\mathbf{v}(n)^T\mathbf{K}^T\mathbf{K}\mathbf{v}(n)]\nonumber\\
      &=~E[\mathbf{z}(n)^T\mathbf{z}(n)]-E[{\mathbf{z}(n)^T\mathbf{K}\mathbf{C}\mathbf{z}(n)}]-E[{\mathbf{z}(n)^T\mathbf{C}^T\mathbf{K}^T\mathbf{z}(n)}]+E[{\mathbf{z}(n)^T\mathbf{C}^T\mathbf{K}^T\mathbf{K}\mathbf{C}\mathbf{z}(n)}]
    +E[\mathbf{v}(n)^T\mathbf{K}^T\mathbf{K}\mathbf{v}(n)]
    \end{align}

    \(\mathbf{K}\)に対する\(J\)の極値条件は次式となります。
    \begin{align}
      \frac{\partial J}{\partial\mathbf{K}}=-2E[{\mathbf{z}(n)^T\mathbf{z}(n)]\mathbf{C}}-2\mathbf{K}\mathbf{C}E[{\mathbf{z}(n)^T\mathbf{z}(n)}]\mathbf{C}+2\mathbf{K}E[\mathbf{v}(n)^T\mathbf{v}(n)]=\mathbf{0} \label{eq:Cond1}
    \end{align}

    <p>ここで、\(\tilde{\mathbf{x}}(n)\)と\(\mathbf{z}(n)\)の相関行列を次式で与えます。</p>
    \begin{align}
      \mathbf{M}(n)&=E[\mathbf{z}(n)^T\mathbf{z}(n)]\\
      \mathbf{P}(n)&=E[\tilde{\mathbf{x}}(n)^T\tilde{\mathbf{x}}(n)] \label{eq:CovarMatOfError}
    \end{align}

    <p>とすると式\eqref{eq:Cond1}は次式になります。</p>
    \begin{align}
      \frac{\partial J}{\partial\mathbf{K}}=-2\mathbf{M}(n)\mathbf{C}^T-2\mathbf{K}\mathbf{C}\mathbf{M}(n)\mathbf{C}^T+2\mathbf{K}\mathbf{V}=\mathbf{0}
    \end{align}

    <p>したがって、\(\mathbf{K}\)に対する\(J\)の極値条件は次式となります。</p>
    \begin{align}
      \mathbf{K}\mathbf{C}\mathbf{M}(n)\mathbf{C}^T+\mathbf{K}\mathbf{V}=\mathbf{M}(n)\mathbf{C}^T \label{eq:KalmanGain1}
    \end{align}

    <p>十分大きな\(n\)に対して相関行列\(E[\tilde{\mathbf{x}}(n)\tilde{\mathbf{w}}^T(n)]=0\)に注意すると式\eqref{eq:StateEqZ}から次式が得られます。</p>
    \begin{align}
      E[\mathbf{z}(n+1)\mathbf{z}^T(n+1)]&=~E[\{\mathbf{A}\tilde{\mathbf{x}}(n)+\mathbf{w}(n)\}\{\mathbf{A}\tilde{\mathbf{x}}(n)+\mathbf{w}(n)^T]\nonumber\\
      &=~\mathbf{A}E[\tilde{\mathbf{x}}(n)\tilde{\mathbf{x}}(n)^T]\mathbf{A}^T+E[\mathbf{w}(n)\mathbf{w}(n)^T\}]\label{eq:VarMatOfZ}
    \end{align}
    
    <p>式\(\eqref{eq:CovarMatOfError}\)を式に代入\(\eqref{eq:ErrorOfEst}\)すると次式が得られます。</p>
    \begin{align}
      \mathbf{P}(n)=E[\{(\mathbf{I}-\mathbf{K}\mathbf{C})\mathbf{z}(n)-\mathbf{K}\mathbf{v}(n)\}\{(\mathbf{I}-\mathbf{K}\mathbf{C})\mathbf{z}(n)-\mathbf{K}\mathbf{v}(n)\}^T]\label{eq:CovarMatOfError2}
    \end{align}

    <p>式\eqref{eq:VarMatOfZ}は次式となります。</p>
    \begin{align}
      \mathbf{M}(n+1)=\mathbf{A}\mathbf{P}(n)\mathbf{A}^T+\mathbf{W} \label{eq:VarMatOfZ2}
    \end{align}

    <p>十分大きな\(n\)に対して\(E[\mathbf{z}(n)\mathbf{v}^T(n)]=\mathbf{0}\)に注意すると式\eqref{eq:CovarMatOfError2}は次式になります。</p>
    \begin{align}
      \mathbf{P}(n)=(\mathbf{I}-\mathbf{K}\mathbf{C})\mathbf{M}(n)(\mathbf{I}-\mathbf{K}\mathbf{C})^T+\mathbf{K}\mathbf{V}\mathbf{K}^T \label{eq:MatP1}
    \end{align}

    <p>式\eqref{eq:KalmanGain1}の両辺に右側から\(\mathbf{K}^T\)を乗ずることにより次式が得られます。</p>
    \begin{align}
      \mathbf{K}\mathbf{V}\mathbf{K}^T=(\mathbf{I}-\mathbf{K}\mathbf{C}^T)\mathbf{M}(n)\mathbf{C}^T\mathbf{K}^T \label{eq:KVK}
    \end{align}

    <p>\eqref{eq:MatP1}の\(\mathbf{KVK^T}\)に\eqref{eq:KVK}の右辺を代入すると\(\mathbf{P}(n)\)は次式となります。</p>
    \begin{align}
      \mathbf{P}(n)=(\mathbf{I}-\mathbf{K}\mathbf{C})\mathbf{M}(n)\label{eq:MatP2}
    \end{align}

    <p>さらに式\eqref{eq:VarMatOfZ2}と\eqref{eq:MatP2}から\(\mathbf{P}(n)\)は次式となります。</p>
    \begin{align}
      \mathbf{P}(n)=(\mathbf{I}-\mathbf{K}\mathbf{C})(\mathbf{A}\mathbf{P}(n-1)\mathbf{A}^T+\mathbf{W}^T) \label{eq:MatP3}
    \end{align}

    <p>式\eqref{eq:KalmanGain1}より\(\mathbf{KV}=(\mathbf{I}-\mathbf{KC})\mathbf{M}(n)\mathbf{C}^T\)となるので、
    式\eqref{eq:MatP3}より次式が得られます。</p>
    \begin{align}
      \mathbf{K}\mathbf{V}=\mathbf{P}(n)\mathbf{C}^T \label{eq:KV}
    \end{align}

    <p>\(\displaystyle\lim_{k \rightarrow \infty}\mathbf{P}(n) = \mathbf{P}\)となりますので、式\eqref{eq:KV}の両辺に右から\(\mathbf{V}^{-1}\)を乗ずることによりカルマンゲイン行列\(\mathbf{K}\)は次式となります。</p>
    \begin{align*}
      \mathbf{K}=\mathbf{P}\mathbf{C}^T\mathbf{V}^{-1}
    \end{align*}

    <p><a href="https://aoyamakohbo.github.io/Craftlogy/">->TOP</a></p>
</body>
</html>
